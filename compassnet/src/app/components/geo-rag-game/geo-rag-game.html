<div class="wrap">
  <!-- ===== Top Controls ===== -->
  <header class="topbar">
    <h1>üåç Geo RAG ‚Äî Real-Time Geopolitical Game</h1>

    <div class="controls">
      <label class="ctrl">
        <span>Role</span>
        <select [(ngModel)]="roleId" (change)="onRoleChanged()">
          <option *ngFor="let id of roleIds" [value]="id">{{ roleOptions[id] }}</option>
        </select>
      </label>

      <label class="ctrl check">
        <input type="checkbox" [(ngModel)]="autoAdvance" />
        <span>Auto-advance</span>
      </label>

      <label class="ctrl check">
        <input type="checkbox" [(ngModel)]="showXai" />
        <span>üß† XAI</span>
      </label>

      <button class="btn primary" (click)="startNewGame()" [disabled]="loading">
        <ng-container *ngIf="!loading">üöÄ Start</ng-container>
        <ng-container *ngIf="loading">Loading‚Ä¶</ng-container>
      </button>
    </div>
  </header>

  <!-- ===== Main layout ===== -->
  <section class="board">
    <!-- Main column -->
    <div class="main">
      <!-- Role details -->
      <details class="panel role">
        <summary>Role Details</summary>
        <div class="role-body" *ngIf="selectedRole">
          <div class="role-name">{{ selectedRole.name }}</div>
          <div class="role-profile">{{ selectedRole.profile }}</div>
          <div class="role-cols">
            <div>
              <h4>Objectives</h4>
              <ul><li *ngFor="let o of selectedRole.objectives">{{ o }}</li></ul>
            </div>
            <div>
              <h4>Constraints</h4>
              <ul><li *ngFor="let c of selectedRole.constraints">{{ c }}</li></ul>
            </div>
            <div class="tools">
              <h4>Tools</h4>
              <ul class="tools-list">
                <li *ngFor="let t of selectedRole.tools">{{ t }}</li>
              </ul>
            </div>
          </div>
        </div>
      </details>

      <!-- 1) Pick an Event -->
      <article class="panel">
        <h2>1) Pick an Event</h2>

        <div *ngIf="!sessionId" class="note info">Start a new game in the top bar to fetch live events.</div>
        <div *ngIf="sessionId && events.length === 0" class="note warn">No events available yet. Try starting a new game again.</div>

        <ng-container *ngIf="sessionId && events.length">
          <label class="block">
            <span class="label">Select a headline</span>
            <select class="select" [(ngModel)]="selectedEventIndex">
              <option *ngFor="let ev of events; index as i" [ngValue]="i">
                {{ i + 1 }}. {{ ev.title }}  [{{ ev.source_name || '' }}]
              </option>
            </select>
          </label>

          <div class="actions">
            <button class="btn" (click)="startSelectedTurn()" [disabled]="ended || loading">üé¨ Start Turn with Selected Event</button>
            <button class="btn" (click)="nextTurn()" [disabled]="ended || loading" title="Advance same event">‚è≠Ô∏è Next Turn</button>
          </div>
        </ng-container>
      </article>

      <!-- 2) Scene -->
      <article class="panel">
        <h2>2) Scene</h2>

        <div *ngIf="!scene" class="note info">Start a turn to see the scene and choices.</div>

        <ng-container *ngIf="scene as s">
          <div class="scene-meta">
            <div><b>Turn:</b> {{ s.turn }}</div>
            <div><b>Turns Left:</b> {{ s.turns_left }}</div>
            <span class="end-badge" *ngIf="s.ended">GAME OVER</span>
          </div>

          <div class="scene-grid">
            <div class="scene-text">
              <h3>Brief Narrative</h3>
              <p class="prose">{{ extractBrief(s.scene_text) }}</p>

              <h3>Decision Options</h3>
              <div class="options-grid">
                <button class="opt"
                        *ngFor="let k of ['1','2','3','4']"
                        [disabled]="ended || !parseOptions(s.scene_text)[k]"
                        (click)="chooseOption(+k)">
                  <span class="opt-num">{{ k }}</span>
                  <span class="opt-text">{{ parseOptions(s.scene_text)[k] || '‚Äî' }}</span>
                </button>
              </div>

              <details class="xai" *ngIf="showXai && extractWhyOptions(s.scene_text).length">
                <summary>üß† Why these options matter</summary>
                <ul><li *ngFor="let r of extractWhyOptions(s.scene_text)">{{ r }}</li></ul>
              </details>
            </div>
            <!-- Image moved to sidebar; keep the right cell empty to preserve grid spacing -->
            <div></div>
          </div>
        </ng-container>
      </article>

      <!-- 3) Consequences -->
      <article class="panel">
        <h2>3) Consequences</h2>

        <div *ngIf="!consequence" class="note info">Pick a decision (1‚Äì4) to see consequences and updated metrics.</div>

        <ng-container *ngIf="consequence as c">
          <div class="scene-meta">
            <div><b>Turn:</b> {{ c.turn }} (after choice)</div>
            <div><b>Turns Left:</b> {{ c.turns_left }}</div>
            <span class="end-badge" *ngIf="c.ended">GAME OVER</span>
          </div>

          <div class="cons-grid">
            <div class="cons-text">
              <p class="prose">{{ c.consequence_text }}</p>

              <details class="xai" *ngIf="showXai">
                <summary>üß† Why metrics changed</summary>
                <div class="metrics-xai">
                  <div *ngFor="let k of metricKeys">
                    <b>{{ k }}:</b> {{ extractMetricRationales(c.consequence_text)[k] || '‚Äî' }}
                  </div>
                </div>
              </details>
            </div>
            <!-- Image stays in sidebar only -->
            <div></div>
          </div>
        </ng-container>
      </article>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Reality Check FIRST so it never hides under Metrics -->
      <article class="panel">
        <h2>Reality Check</h2>
        <button class="btn" (click)="fetchReality()" [disabled]="!sessionId || ended || loading">
          üîé Fresh headlines on current event
        </button>
        <div class="reality" *ngIf="realityHeadlines.length">
          <div class="headline" *ngFor="let h of realityHeadlines">
            <a [href]="h.url" target="_blank">{{ h.title }}</a>
            <div class="caption">[{{ h.source_name }}] ({{ h.published_at || 'n/a' }})</div>
          </div>
        </div>
      </article>

      <!-- Metrics -->
      <article class="panel">
        <h2>Metrics</h2>

        <div *ngIf="!sessionId" class="note info">Metrics will appear after you start a game.</div>

        <ng-container *ngIf="sessionId">
          <div class="metrics-list" *ngIf="metrics">
            <div class="metric" *ngFor="let k of metricKeys">
              <div class="label">{{ k }}</div>
              <div class="value">
                {{ (metrics[k] ?? 0) | number:'1.0-2' }}
                <span class="chip"
                      [class.up]="deltaOf(k) > 0"
                      [class.down]="deltaOf(k) < 0"
                      [class.neutral]="deltaOf(k) === 0">
                  <ng-container [ngSwitch]="true">
                    <span *ngSwitchCase="deltaOf(k) > 0">‚Üë</span>
                    <span *ngSwitchCase="deltaOf(k) < 0">‚Üì</span>
                    <span *ngSwitchDefault>¬±</span>
                  </ng-container>
                  {{ deltaOf(k) >= 0 ? '+' : '' }}{{ deltaOf(k) | number:'1.0-2' }}
                </span>
              </div>
            </div>
          </div>

          <div class="prev" *ngIf="statusTurn !== null">
            <div class="caption">Turn: {{ statusTurn }}</div>
            <div *ngIf="prevSummary">
              <b>Prev Summary</b>
              <p class="prose">{{ prevSummary }}</p>
            </div>
          </div>

          <div *ngIf="ended" class="end-note">
            <span class="end-badge">GAME OVER ‚Äî start a new game from the top bar</span>
          </div>
        </ng-container>
      </article>

      <!-- Single global Image card (always shows the latest image) -->
      <article class="panel image-card">
        <h2>Image</h2>
        <div class="image-box tall">
          <img
            *ngIf="imageSrc(latestImageValue()) as src"
            [src]="src"
            alt="Latest image"
          />
          <div class="noimg" *ngIf="!imageSrc(latestImageValue())">No image yet.</div>
        </div>
        <div class="media-actions">
          <button class="btn" (click)="reloadLatestImage()" [disabled]="loading || (!scene && !consequence)">‚Üª Reload image</button>
        </div>
        <div class="caption">
          <ng-container *ngIf="consequence; else sceneLabel">After-choice image</ng-container>
          <ng-template #sceneLabel>Scene image</ng-template>
        </div>
      </article>
    </aside>
  </section>
</div>
