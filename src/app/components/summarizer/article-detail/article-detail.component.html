<div class="wrap">
  <!-- Loading -->
  <div *ngIf="loading()" class="loading-state">
    <div class="spinner"></div>
    <p>Loading article...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error()" class="error-container">
    <div class="panel error-panel">
      <h2>âŒ Error</h2>
      <p>{{ error() }}</p>
      <button (click)="goBack()" class="btn primary">â† Back to list</button>
    </div>
  </div>

  <!-- Article Content -->
  <div *ngIf="!loading() && !error() && article()">
    <!-- Top Bar -->
    <div class="topbar">
      <div>
        <a routerLink="/summarizer" class="back-link">â† Back to list</a>
        <h1>{{ art.summaries[0]?.title || 'Article' }}</h1>
      </div>
      
      <div class="controls">
        <div class="meta-badges">
          <span *ngIf="art.source_name" class="badge">ğŸ“° {{ art.source_name }}</span>
          <span *ngIf="art.summaries[0]?.date_published" class="badge">
            ğŸ“… {{ art.summaries[0].date_published }}
          </span>
        </div>
        
        <a *ngIf="art.source_url" 
           [href]="art.source_url" 
           target="_blank"
           class="btn primary">
          ğŸ”— Read original
        </a>
      </div>
    </div>

    <!-- Main Board Layout -->
    <div class="board">
      <!-- Main Content -->
      <div class="main">
        <!-- Image -->
        <div *ngIf="art.image_url" class="panel">
          <div class="article-image-container">
            <img [src]="art.image_url" 
                 [alt]="art.summaries[0]?.title || 'Article'" 
                 class="article-image">
          </div>
        </div>

        <!-- Summaries -->
        <div class="panel">
          <h2>âœ¨ Intelligent Summaries</h2>
          
          <div class="summaries-list">
            <div *ngFor="let summary of art.summaries; trackBy: trackBySummaryId" 
                 class="summary-block">
              
              <!-- Header with Method Badge -->
              <div class="summary-header">
                <span class="method-badge"
                      [ngClass]="{
                        'hybrid': summary.method === 'hybrid',
                        'llama': summary.method === 'llama_full'
                      }">
                  {{ summary.method === 'hybrid' ? 'ğŸ† HYBRID' : 'ğŸ¤– LLAMA' }}
                </span>
                
                <span *ngIf="summary.overall_score" class="score-badge">
                  Score: <strong>{{ (summary.overall_score * 100).toFixed(1) }}%</strong>
                </span>
              </div>
              
              <h3 class="summary-title">{{ summary.title }}</h3>
              <p class="summary-text">{{ summary.summary }}</p>
              
              <!-- 5W1H Structure -->
              <details *ngIf="summary.structure_5w1h && objectKeys(summary.structure_5w1h).length > 0" 
                       class="structure-details">
                <summary>ğŸ” 5W1H Structure</summary>
                <div class="structure-grid">
                  <div *ngFor="let item of objectEntries(summary.structure_5w1h).slice(0, 4)" 
                       class="structure-item">
                    <strong>{{ item.key }}:</strong>
                    <p *ngIf="item.value && item.value.length > 0">
                      {{ item.value.slice(0, 2).join(', ') }}
                    </p>
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>

        <!-- XAI Section -->
        <div class="panel">
          <div class="xai-header">
            <h2>ğŸ¤– Explainable AI (XAI)</h2>
            
            <div class="xai-controls">
              <button *ngIf="!art.xai_cached"
                      (click)="generateXAI()"
                      [disabled]="generatingXAI()"
                      class="btn primary">
                <span *ngIf="!generatingXAI()">ğŸ”¬ Generate XAI Analysis</span>
                <span *ngIf="generatingXAI()" class="loading-inline">
                  <div class="spinner-small"></div>
                  Generating...
                </span>
              </button>
              
              <span *ngIf="art.xai_cached" class="badge success">âœ… XAI Cached</span>
            </div>
          </div>
          
          <!-- XAI Content -->
          <div *ngIf="art.xai_cached && art.xai_explanation" 
               class="xai-content" 
               [innerHTML]="renderXAI(art.xai_explanation)"></div>
          
          <!-- XAI Placeholder -->
          <div *ngIf="!art.xai_cached" class="note info">
            <div class="placeholder-icon">ğŸ”¬</div>
            <h4>XAI Analysis Available</h4>
            <p>
              Click the button above to generate a detailed explanatory analysis<br>
              using SHAP, LIME and BART attention analysis.
            </p>
            <div class="xai-features">
              <p>âœ¨ Estimated time: 5-10 seconds</p>
              <p>ğŸ’¾ Result saved for instant future access</p>
            </div>
          </div>
        </div>

        <!-- Full Article -->
        <div class="panel">
          <h2>ğŸ“„ Full Article</h2>
          <div class="prose">{{ art.original_text }}</div>
          
          <div class="article-stats">
            <span><strong>Words:</strong> {{ getWordCount(art.original_text) }}</span>
            <span><strong>Source:</strong> {{ art.source_name }}</span>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="nav-buttons">
          <button (click)="goBack()" class="btn primary">â† Back</button>
          <a *ngIf="art.source_url" 
             [href]="art.source_url" 
             target="_blank"
             class="btn">
            ğŸ”— Original
          </a>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Quick Info -->
        <div class="panel">
          <h2>ğŸ“Š Quick Info</h2>
          <div class="metrics-list">
            <div class="metric">
              <span class="label">Summaries</span>
              <span class="value">{{ art.summaries.length }}</span>
            </div>
            <div class="metric">
              <span class="label">Word Count</span>
              <span class="value">{{ getWordCount(art.original_text) }}</span>
            </div>
            <div class="metric">
              <span class="label">XAI Status</span>
              <span class="value">
                <span class="chip" [ngClass]="art.xai_cached ? 'up' : 'neutral'">
                  {{ art.xai_cached ? 'âœ“ Cached' : 'â—‹ Not Generated' }}
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- Image Preview (if available) -->
        <div *ngIf="art.image_url" class="panel image-card">
          <h2>ğŸ–¼ï¸ Preview</h2>
          <div class="image-box tall">
            <img [src]="art.image_url" [alt]="art.summaries[0]?.title || 'Article'">
          </div>
        </div>

        <!-- Source Info -->
        <div class="panel">
          <h2>ğŸ“° Source</h2>
          <div class="reality">
            <div class="headline">
              <strong>{{ art.source_name }}</strong>
              <a *ngIf="art.source_url" 
                 [href]="art.source_url" 
                 target="_blank" 
                 class="block caption">
                View original â†’
              </a>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>